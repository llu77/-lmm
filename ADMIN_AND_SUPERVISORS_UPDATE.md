# ุชุญุฏูุซ ูููุฉ ูุฑูุฑ ุงูุฃุฏูู ูุฃุณูุงุก ุงููุดุฑููู

## ูุธุฑุฉ ุนุงูุฉ

ุชู ุชุญุฏูุซ ุงููุธุงู ูุชุทุจูู ุงููุชุทูุจุงุช ุงูุชุงููุฉ:
1. **ุชุบููุฑ ูููุฉ ูุฑูุฑ ุงูุฃุฏูู** ุฅูู `Omar101010`
2. **ุชุญุฏูุซ ุฃุณูุงุก ุงููุดุฑููู** ูููุฑูุน
3. **ุงูุชุญูู ูู ุนุฒู ุจูุงูุงุช ุงููุฑูุน** ูุนุฏู ุชุฏุงุฎููุง
4. **ุงูุชุญูู ูู ุชูุงูู ุงูุตูุงุญูุงุช** ูุน Cloudflare ูุงูู middleware

---

## ๐ ุจูุงูุงุช ุชุณุฌูู ุงูุฏุฎูู

### ุงูุฃุฏูู (ุตูุงุญูุงุช ูุงููุฉ)
- **ุงุณู ุงููุณุชุฎุฏู**: `admin`
- **ูููุฉ ุงููุฑูุฑ**: `Omar101010`
- **ุงูุตูุงุญูุงุช**: 
  - โ ุนุฑุถ ุฌููุน ุงููุฑูุน
  - โ ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู
  - โ ุฅุฏุงุฑุฉ ุงูุฅุนุฏุงุฏุงุช
  - โ ุฅุฏุงุฑุฉ ุงููุฑูุน
  - โ ุงููุตูู ุงููุงูู ููู ุงูุจูุงูุงุช

### ูุดุฑู ูุฑุน ุทููู (ูุญูุฏ ุฅุณูุงุนูู)
- **ุงุณู ุงููุณุชุฎุฏู**: `supervisor_tuwaiq`
- **ูููุฉ ุงููุฑูุฑ**: `tuwaiq2020`
- **ุงููุฑุน**: `branch_2020` (ูุฑุน ุทููู ููุท)
- **ุงูุตูุงุญูุงุช**:
  - โ ุฅุฏุงุฑุฉ ููุธูู ูุฑุนู ููุท
  - โ ุฅุถุงูุฉ ุงูุฅูุฑุงุฏุงุช ูุงููุตุฑููุงุช ููุฑุนู
  - โ ุนุฑุถ ุชูุงุฑูุฑ ูุฑุนู ููุท
  - โ ูุง ููููู ุนุฑุถ ุงููุฑูุน ุงูุฃุฎุฑู
  - โ ูุง ููููู ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู

### ูุดุฑู ูุฑุน ูุจู (ุนุจุฏุงูุญู ุฌูุงู)
- **ุงุณู ุงููุณุชุฎุฏู**: `supervisor_laban`
- **ูููุฉ ุงููุฑูุฑ**: `laban1010`
- **ุงููุฑุน**: `branch_1010` (ูุฑุน ูุจู ููุท)
- **ุงูุตูุงุญูุงุช**:
  - โ ุฅุฏุงุฑุฉ ููุธูู ูุฑุนู ููุท
  - โ ุฅุถุงูุฉ ุงูุฅูุฑุงุฏุงุช ูุงููุตุฑููุงุช ููุฑุนู
  - โ ุนุฑุถ ุชูุงุฑูุฑ ูุฑุนู ููุท
  - โ ูุง ููููู ุนุฑุถ ุงููุฑูุน ุงูุฃุฎุฑู
  - โ ูุง ููููู ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู

---

## ๐ ุฌุฏูู ุงูุตูุงุญูุงุช ุงูููุงุฑู

| ุงูุตูุงุญูุฉ | ุงูุฃุฏูู | ูุดุฑู ุทููู | ูุดุฑู ูุจู |
|---------|--------|-----------|----------|
| ุนุฑุถ ุฌููุน ุงููุฑูุน | โ | โ (ุทููู ููุท) | โ (ูุจู ููุท) |
| ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู | โ | โ | โ |
| ุฅุฏุงุฑุฉ ุงูุฅุนุฏุงุฏุงุช | โ | โ | โ |
| ุฅุฏุงุฑุฉ ุงููุฑูุน | โ | โ | โ |
| ุฅุฏุงุฑุฉ ุงูููุธููู | โ (ูู ุงููุฑูุน) | โ (ูุฑุนู ููุท) | โ (ูุฑุนู ููุท) |
| ุฅุถุงูุฉ ุฅูุฑุงุฏุงุช | โ (ูู ุงููุฑูุน) | โ (ูุฑุนู ููุท) | โ (ูุฑุนู ููุท) |
| ุฅุถุงูุฉ ูุตุฑููุงุช | โ (ูู ุงููุฑูุน) | โ (ูุฑุนู ููุท) | โ (ูุฑุนู ููุท) |
| ุนุฑุถ ุงูุชูุงุฑูุฑ | โ (ูู ุงููุฑูุน) | โ (ูุฑุนู ููุท) | โ (ูุฑุนู ููุท) |

---

## ๐ ุนุฒู ุจูุงูุงุช ุงููุฑูุน

### ุขููุฉ ุงูุนุฒู
ุชู ุชุทุจูู ุนุฒู ุจูุงูุงุช ุงููุฑูุน ุนูู ูุณุชูู:

1. **ูุงุนุฏุฉ ุงูุจูุงูุงุช**: ูู ุณุฌู ูุญุชูู ุนูู `branch_id`
2. **API Endpoints**: ุฌููุน ุงูู endpoints ุชุทุจู ุงูุชุญูู ูู ุงูุตูุงุญูุงุช
3. **Middleware**: ูุชุญูู ูู ุตูุงุญูุงุช ุงููุณุชุฎุฏู ูุจู ุงููุตูู
4. **Permissions System**: ูุธุงู ุตูุงุญูุงุช ูุชูุฏู ูู `src/lib/permissions.ts`

### ุงูู API Endpoints ุงููุญููุฉ

#### `/api/branches/list`
- **ุงูุฃุฏูู**: ูุนุฑุถ ูู ุงููุฑูุน
- **ุงููุดุฑู**: ูุนุฑุถ ูุฑุนู ููุท

#### `/api/employees/list`
- **ุงูุฃุฏูู**: ูุนุฑุถ ููุธูู ูู ุงููุฑูุน
- **ุงููุดุฑู**: ูุนุฑุถ ููุธูู ูุฑุนู ููุท

#### `/api/revenues/list-rbac`
- **ุงูุฃุฏูู**: ูุนุฑุถ ุฅูุฑุงุฏุงุช ูู ุงููุฑูุน
- **ุงููุดุฑู**: ูุนุฑุถ ุฅูุฑุงุฏุงุช ูุฑุนู ููุท

#### `/api/expenses/list`
- **ุงูุฃุฏูู**: ูุนุฑุถ ูุตุฑููุงุช ูู ุงููุฑูุน
- **ุงููุดุฑู**: ูุนุฑุถ ูุตุฑููุงุช ูุฑุนู ููุท

#### `/api/payroll/list`
- **ุงูุฃุฏูู**: ูุนุฑุถ ูุดูู ุฑูุงุชุจ ูู ุงููุฑูุน
- **ุงููุดุฑู**: ูุนุฑุถ ูุดูู ุฑูุงุชุจ ูุฑุนู ููุท

---

## ๐๏ธ ุงูุชุนุฏููุงุช ุงูุชูููุฉ

### 1. ูููุงุช Migration ุงูุฌุฏูุฏุฉ

#### `migrations/006_update_admin_password.sql`
```sql
-- ุชุญุฏูุซ ูููุฉ ูุฑูุฑ ุงูุฃุฏูู ุฅูู Omar101010
UPDATE users_new
SET password = 'd3d95716f02dea05fde0c75ce8d0aee0016718722d67d8ba5b44ab25feee0ccf',
    updated_at = datetime('now')
WHERE username = 'admin' AND role_id = 'role_admin';
```

#### `migrations/007_update_supervisors_names.sql`
```sql
-- ุชุญุฏูุซ ุงุณู ูุดุฑู ุทููู
UPDATE users_new
SET full_name = 'ูุญูุฏ ุฅุณูุงุนูู - ูุดุฑู ูุฑุน ุทููู'
WHERE username = 'supervisor_tuwaiq';

-- ุชุญุฏูุซ ุงุณู ูุดุฑู ูุจู
UPDATE users_new
SET full_name = 'ุนุจุฏุงูุญู ุฌูุงู - ูุดุฑู ูุฑุน ูุจู'
WHERE username = 'supervisor_laban';
```

### 2. ุชุญุฏูุซ API Endpoints

#### `src/pages/api/employees/list.ts`
ุชู ุชุญุฏูุซู ูุชุทุจูู ุนุฒู ุงููุฑูุน:
- ุงุณุชุฎุฏุงู `requireAuthWithPermissions` ุจุฏูุงู ูู `requireAuth`
- ุงูุชุญูู ูู ุตูุงุญูุฉ `canViewReports`
- ุชุทุจูู `validateBranchAccess` ููุชุญูู ูู ุงููุตูู
- ุงุณุชุฎุฏุงู `getBranchFilterSQL` ูููุชุฑุฉ ุงูุจูุงูุงุช

### 3. ูุธุงู ุงูุตูุงุญูุงุช (Permissions System)

ุงูููุฌูุฏ ูู `src/lib/permissions.ts`:
- `loadUserPermissions()`: ุชุญููู ุตูุงุญูุงุช ุงููุณุชุฎุฏู
- `requireAuthWithPermissions()`: ุงูุชุญูู ูู ุงูุตูุงุญูุงุช
- `validateBranchAccess()`: ุงูุชุญูู ูู ุงููุตูู ูููุฑุน
- `getBranchFilterSQL()`: ุฅูุดุงุก ููุชุฑ SQL ูุนุฒู ุงููุฑูุน
- `canAccessBranch()`: ุงูุชุญูู ูู ุฅููุงููุฉ ุงููุตูู

### 4. Middleware

ุงูููุฌูุฏ ูู `src/middleware.ts`:
- ูุชุญูู ูู ุงูู session
- ูุญูู ุจูุงูุงุช ุงููุณุชุฎุฏู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- ูุทุจู ุงูุญูุงูุฉ ุนูู ุงูุตูุญุงุช ุงููุญููุฉ
- ูุถูู security headers

---

## ๐ ุฎุทูุงุช ุชุทุจูู ุงูุชุญุฏูุซุงุช

### ุนูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงููุญููุฉ

```bash
cd symbolai-worker

# ุชุทุจูู migration ูููุฉ ูุฑูุฑ ุงูุฃุฏูู
npx wrangler d1 execute DB --local --file=./migrations/006_update_admin_password.sql

# ุชุทุจูู migration ุฃุณูุงุก ุงููุดุฑููู
npx wrangler d1 execute DB --local --file=./migrations/007_update_supervisors_names.sql

# ุงูุชุญูู ูู ุงูุชุญุฏูุซุงุช
npx wrangler d1 execute DB --local --command="SELECT username, full_name, role_id, branch_id FROM users_new WHERE role_id IN ('role_admin', 'role_supervisor');"
```

### ุนูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุฅูุชุงุฌูุฉ

```bash
cd symbolai-worker

# ุชุทุจูู migration ูููุฉ ูุฑูุฑ ุงูุฃุฏูู
npx wrangler d1 execute DB --remote --file=./migrations/006_update_admin_password.sql

# ุชุทุจูู migration ุฃุณูุงุก ุงููุดุฑููู
npx wrangler d1 execute DB --remote --file=./migrations/007_update_supervisors_names.sql

# ุงูุชุญูู ูู ุงูุชุญุฏูุซุงุช
npx wrangler d1 execute DB --remote --command="SELECT username, full_name, role_id, branch_id FROM users_new WHERE role_id IN ('role_admin', 'role_supervisor');"
```

---

## โ ุงุฎุชุจุงุฑุงุช ุงูุชุญูู

### 1. ุงุฎุชุจุงุฑ ุชุณุฌูู ุงูุฏุฎูู

```bash
# ุงุฎุชุจุงุฑ ุงูุฃุฏูู
curl -X POST http://localhost:4321/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"Omar101010"}'

# ุงุฎุชุจุงุฑ ูุดุฑู ุทููู
curl -X POST http://localhost:4321/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"supervisor_tuwaiq","password":"tuwaiq2020"}'

# ุงุฎุชุจุงุฑ ูุดุฑู ูุจู
curl -X POST http://localhost:4321/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"supervisor_laban","password":"laban1010"}'
```

### 2. ุงุฎุชุจุงุฑ ุนุฒู ุงููุฑูุน

ุจุนุฏ ุชุณุฌูู ุงูุฏุฎููุ ุงุฎุชุจุฑ:

```bash
# ุนุฑุถ ุงููุฑูุน (ุงููุดุฑู ูุฌุจ ุฃู ูุฑู ูุฑุนู ููุท)
curl -X GET http://localhost:4321/api/branches/list \
  -H "Cookie: session=<token>"

# ุนุฑุถ ุงูููุธููู (ุงููุดุฑู ูุฌุจ ุฃู ูุฑู ููุธูู ูุฑุนู ููุท)
curl -X GET http://localhost:4321/api/employees/list \
  -H "Cookie: session=<token>"
```

### 3. ุงุณุชุฎุฏุงู ุณูุฑูุจุช ุงูุงุฎุชุจุงุฑ

```bash
cd symbolai-worker
chmod +x test-admin-and-supervisors.js
node test-admin-and-supervisors.js
```

---

## ๐ ุงูุฃูุงู

### ุชุดููุฑ ูููุงุช ุงููุฑูุฑ
- ูุชู ุงุณุชุฎุฏุงู SHA-256 ูุชุดููุฑ ูููุงุช ุงููุฑูุฑ
- ูููุงุช ุงููุฑูุฑ ูุง ุชูุฎุฒู ุจุดูู ูุตู ูุงุถุญ
- ูู ูููุฉ ูุฑูุฑ ููุง hash ูุฑูุฏ

### ูุซุงู ุนูู hash ูููุฉ ุงููุฑูุฑ:
```javascript
const crypto = require('crypto');
const password = 'Omar101010';
const hash = crypto.createHash('sha256').update(password).digest('hex');
// ุงููุชูุฌุฉ: d3d95716f02dea05fde0c75ce8d0aee0016718722d67d8ba5b44ab25feee0ccf
```

### Session Management
- ูุชู ุงุณุชุฎุฏุงู Cloudflare KV ูุชุฎุฒูู ุงูู sessions
- ูู session ููุง expiration time (7 ุฃูุงู)
- ูุชู ุงูุชุญูู ูู ุงูู session ูู ูู ุทูุจ

---

## ๐ ุงููููุงุช ุงููุฑุฌุนูุฉ

- `src/lib/permissions.ts` - ูุธุงู ุงูุตูุงุญูุงุช
- `src/middleware.ts` - Middleware ููุญูุงูุฉ
- `src/pages/api/auth/login.ts` - API ุชุณุฌูู ุงูุฏุฎูู
- `src/pages/api/employees/list.ts` - API ุนุฑุถ ุงูููุธููู (ูุญุฏุซ)
- `migrations/006_update_admin_password.sql` - ุชุญุฏูุซ ูููุฉ ูุฑูุฑ ุงูุฃุฏูู
- `migrations/007_update_supervisors_names.sql` - ุชุญุฏูุซ ุฃุณูุงุก ุงููุดุฑููู

---

## ๐ฏ ุฎูุงุตุฉ

ุชู ุชูููุฐ ุฌููุน ุงููุชุทูุจุงุช ุจูุฌุงุญ:

โ ุชุบููุฑ ูููุฉ ูุฑูุฑ ุงูุฃุฏูู ุฅูู Omar101010  
โ ุชุญุฏูุซ ุงุณู ูุดุฑู ุทููู ุฅูู ูุญูุฏ ุฅุณูุงุนูู  
โ ุชุญุฏูุซ ุงุณู ูุดุฑู ูุจู ุฅูู ุนุจุฏุงูุญู ุฌูุงู  
โ ุงูุชุฃูุฏ ูู ุนุฒู ุจูุงูุงุช ุงููุฑูุน ูุนุฏู ุชุฏุงุฎููุง  
โ ุงูุชุญูู ูู ุชูุงูู ุงูุตูุงุญูุงุช ูุน Cloudflare ูุงูู middleware  
โ ุงูุฃุฏูู ูุฏูู ุตูุงุญูุงุช ูุงููุฉ ุนูู ูู ุงููุฑูุน  
โ ูู ูุดุฑู ุตูุงุญูุงุชู ูุญุตูุฑุฉ ูู ูุฑุนู ููุท  

---

## ๐ ุงูุฏุนู

ููุฃุณุฆูุฉ ุฃู ุงููุดุงููุ ูุฑุฌู ูุชุญ issue ูู GitHub repository.
