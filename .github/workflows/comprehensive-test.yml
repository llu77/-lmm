name: Comprehensive Tests and Quality Checks

on:
  push:
    branches:
      - main
      - 'copilot/**'
  pull_request:
    branches:
      - main
  workflow_dispatch:

# Prevent concurrent test runs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Job 1: Type checking
  type-check:
    name: TypeScript Type Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Run TypeScript type check
        run: npm run type-check

  # Job 2: Linting
  lint:
    name: ESLint Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Run ESLint
        run: npm run lint

  # Job 3: Build test
  build:
    name: Build All Workspaces
    runs-on: ubuntu-latest
    needs: [type-check, lint]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Build symbolai-worker
        run: |
          cd symbolai-worker
          NODE_OPTIONS='--max-old-space-size=2048' npm run build

      - name: Build cloudflare-worker
        run: |
          cd cloudflare-worker
          npm run build
        continue-on-error: true

      - name: Build MCP server
        run: |
          cd my-mcp-server-github-auth
          npm run build
        continue-on-error: true

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            symbolai-worker/dist/
            cloudflare-worker/dist/
          retention-days: 1

  # Job 4: Dependency audit
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Run npm audit
        run: npm run audit
        continue-on-error: true

  # Job 5: Configuration validation
  config-validation:
    name: Configuration Files Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate package.json files
        run: |
          echo "Validating package.json files..."
          for pkg in package.json symbolai-worker/package.json cloudflare-worker/package.json my-mcp-server-github-auth/package.json; do
            if [ -f "$pkg" ]; then
              echo "âœ“ Checking $pkg"
              node -e "JSON.parse(require('fs').readFileSync('$pkg', 'utf8'))" || exit 1
            fi
          done

      - name: Validate tsconfig.json
        run: |
          echo "Validating tsconfig.json..."
          if [ -f "tsconfig.json" ]; then
            node -e "JSON.parse(require('fs').readFileSync('tsconfig.json', 'utf8').replace(/\/\*[\s\S]*?\*\/|\/\/.*/g,''))" || exit 1
          fi

      - name: Validate wrangler configs
        run: |
          echo "Validating wrangler configuration files..."
          for config in wrangler.toml wrangler.json wrangler.jsonc; do
            if [ -f "$config" ]; then
              echo "âœ“ Found $config"
            fi
          done

  # Job 6: React version compatibility check
  react-compatibility:
    name: React Version Compatibility
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Check React versions compatibility
        run: |
          echo "Checking React and React-DOM versions..."
          REACT_VERSION=$(npm list react --depth=0 2>/dev/null | grep "react@" | sed 's/.*react@//' | awk '{print $1}')
          REACT_DOM_VERSION=$(npm list react-dom --depth=0 2>/dev/null | grep "react-dom@" | sed 's/.*react-dom@//' | awk '{print $1}')
          
          echo "React version: $REACT_VERSION"
          echo "React-DOM version: $REACT_DOM_VERSION"
          
          # Extract major.minor versions
          REACT_MAJOR_MINOR=$(echo $REACT_VERSION | cut -d. -f1-2)
          REACT_DOM_MAJOR_MINOR=$(echo $REACT_DOM_VERSION | cut -d. -f1-2)
          
          if [ "$REACT_MAJOR_MINOR" != "$REACT_DOM_MAJOR_MINOR" ]; then
            echo "âŒ React version mismatch detected!"
            echo "React: $REACT_VERSION"
            echo "React-DOM: $REACT_DOM_VERSION"
            exit 1
          else
            echo "âœ… React versions are compatible"
          fi

  # Job 7: Test summary
  test-summary:
    name: Test Summary
    needs: [type-check, lint, build, security-audit, config-validation, react-compatibility]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Generate test summary
        run: |
          echo "## ðŸ§ª Comprehensive Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| TypeScript Type Check | ${{ needs.type-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ESLint Code Quality | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build All Workspaces | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Audit | ${{ needs.security-audit.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Configuration Validation | ${{ needs.config-validation.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| React Compatibility | ${{ needs.react-compatibility.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
