#!/bin/bash

# =====================================================
# SymbolAI Worker - Automated Secrets Setup Script
# =====================================================
#
# This script automatically sets up all required secrets
# for the SymbolAI Worker on Cloudflare Workers.
#
# IMPORTANT SECURITY NOTES:
# 1. Replace placeholder values with your actual API keys
# 2. Run this script immediately after customization
# 3. DELETE this script after running (it contains secrets!)
# 4. NEVER commit this script to git (already gitignored)
#
# Usage:
#   1. Copy this file: cp setup-secrets-now.sh.example setup-secrets-now.sh
#   2. Edit setup-secrets-now.sh and replace all placeholder values
#   3. ./setup-secrets-now.sh
#   4. rm setup-secrets-now.sh (CRITICAL - Delete immediately!)
#
# =====================================================

set -e

# Colors for output
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo "╔════════════════════════════════════════════════════╗"
echo "║   SymbolAI Worker - Automated Secrets Setup       ║"
echo "╚════════════════════════════════════════════════════╝"
echo ""

# Check if wrangler is installed
if ! command -v wrangler &> /dev/null; then
    echo -e "${RED}✗ Wrangler CLI not found${NC}"
    echo "Please install it first: npm install -g wrangler"
    exit 1
fi

echo -e "${GREEN}✓ Wrangler CLI found${NC}"
echo ""

# =====================================================
# REPLACE THESE VALUES WITH YOUR ACTUAL KEYS
# =====================================================

# Anthropic API Key (REQUIRED)
# Get from: https://console.anthropic.com/settings/keys
ANTHROPIC_KEY="sk-ant-api03-REPLACE_WITH_YOUR_ACTUAL_KEY"

# Resend API Key (REQUIRED)
# Get from: https://resend.com/api-keys
RESEND_KEY="re_REPLACE_WITH_YOUR_ACTUAL_KEY"

# Auto-generate SESSION_SECRET (32 bytes random)
SESSION_SECRET=$(openssl rand -base64 32)

# Resend Webhook Secret (OPTIONAL - Replace if using webhooks)
# Get from: https://resend.com/webhooks
RESEND_WEBHOOK_SECRET="whsec_PLACEHOLDER_REPLACE_IF_NEEDED"

# Zapier Webhook URL (OPTIONAL - Replace if using Zapier)
# Get from: https://zapier.com/app/webhooks
ZAPIER_WEBHOOK_URL="https://hooks.zapier.com/hooks/catch/PLACEHOLDER/REPLACE_IF_NEEDED"

# =====================================================
# Validation Check
# =====================================================

echo -e "${BLUE}Validating configuration...${NC}"
echo ""

if [[ "$ANTHROPIC_KEY" == *"REPLACE_WITH_YOUR_ACTUAL_KEY"* ]]; then
    echo -e "${RED}✗ ERROR: ANTHROPIC_API_KEY not configured${NC}"
    echo "Please edit this script and replace ANTHROPIC_KEY with your actual key"
    exit 1
fi

if [[ "$RESEND_KEY" == *"REPLACE_WITH_YOUR_ACTUAL_KEY"* ]]; then
    echo -e "${RED}✗ ERROR: RESEND_API_KEY not configured${NC}"
    echo "Please edit this script and replace RESEND_KEY with your actual key"
    exit 1
fi

echo -e "${GREEN}✓ Configuration validated${NC}"
echo ""

# =====================================================
# Set Secrets in Cloudflare Workers
# =====================================================

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "Setting secrets in Cloudflare Workers..."
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

# Set ANTHROPIC_API_KEY
echo -e "${BLUE}Setting ANTHROPIC_API_KEY...${NC}"
echo "$ANTHROPIC_KEY" | npx wrangler secret put ANTHROPIC_API_KEY --config wrangler.toml
if [ $? -eq 0 ]; then
    echo -e "${GREEN}✓ ANTHROPIC_API_KEY set successfully${NC}"
else
    echo -e "${RED}✗ Failed to set ANTHROPIC_API_KEY${NC}"
fi
echo ""

# Set RESEND_API_KEY
echo -e "${BLUE}Setting RESEND_API_KEY...${NC}"
echo "$RESEND_KEY" | npx wrangler secret put RESEND_API_KEY --config wrangler.toml
if [ $? -eq 0 ]; then
    echo -e "${GREEN}✓ RESEND_API_KEY set successfully${NC}"
else
    echo -e "${RED}✗ Failed to set RESEND_API_KEY${NC}"
fi
echo ""

# Set SESSION_SECRET (auto-generated)
echo -e "${BLUE}Setting SESSION_SECRET (auto-generated)...${NC}"
echo "$SESSION_SECRET" | npx wrangler secret put SESSION_SECRET --config wrangler.toml
if [ $? -eq 0 ]; then
    echo -e "${GREEN}✓ SESSION_SECRET set successfully${NC}"
    echo -e "${YELLOW}  Generated: ${SESSION_SECRET:0:20}...${NC}"
else
    echo -e "${RED}✗ Failed to set SESSION_SECRET${NC}"
fi
echo ""

# Set RESEND_WEBHOOK_SECRET (placeholder)
echo -e "${BLUE}Setting RESEND_WEBHOOK_SECRET...${NC}"
echo "$RESEND_WEBHOOK_SECRET" | npx wrangler secret put RESEND_WEBHOOK_SECRET --config wrangler.toml
if [ $? -eq 0 ]; then
    echo -e "${GREEN}✓ RESEND_WEBHOOK_SECRET set${NC}"
    if [[ "$RESEND_WEBHOOK_SECRET" == *"PLACEHOLDER"* ]]; then
        echo -e "${YELLOW}  ⚠ Using placeholder - update later if needed${NC}"
    fi
else
    echo -e "${RED}✗ Failed to set RESEND_WEBHOOK_SECRET${NC}"
fi
echo ""

# Set ZAPIER_WEBHOOK_URL (placeholder)
echo -e "${BLUE}Setting ZAPIER_WEBHOOK_URL...${NC}"
echo "$ZAPIER_WEBHOOK_URL" | npx wrangler secret put ZAPIER_WEBHOOK_URL --config wrangler.toml
if [ $? -eq 0 ]; then
    echo -e "${GREEN}✓ ZAPIER_WEBHOOK_URL set${NC}"
    if [[ "$ZAPIER_WEBHOOK_URL" == *"PLACEHOLDER"* ]]; then
        echo -e "${YELLOW}  ⚠ Using placeholder - update later if needed${NC}"
    fi
else
    echo -e "${RED}✗ Failed to set ZAPIER_WEBHOOK_URL${NC}"
fi
echo ""

# =====================================================
# Verification
# =====================================================

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "Verifying secrets..."
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

npx wrangler secret list --config wrangler.toml

echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo -e "${GREEN}✅ Secrets Setup Complete!${NC}"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

# =====================================================
# Security Reminder
# =====================================================

echo -e "${RED}╔════════════════════════════════════════════════════╗${NC}"
echo -e "${RED}║           CRITICAL SECURITY REMINDER               ║${NC}"
echo -e "${RED}╚════════════════════════════════════════════════════╝${NC}"
echo ""
echo -e "${YELLOW}⚠️  DELETE THIS SCRIPT IMMEDIATELY!${NC}"
echo ""
echo "This script contains your actual API keys and must not be"
echo "left on disk or committed to version control."
echo ""
echo "Run this command now:"
echo -e "${RED}  rm setup-secrets-now.sh${NC}"
echo ""
echo "To verify it's deleted:"
echo "  ls -la setup-secrets-now.sh"
echo ""
echo "If you need to update secrets later, use:"
echo "  echo 'new_value' | wrangler secret put SECRET_NAME"
echo ""

# =====================================================
# Next Steps
# =====================================================

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "Next Steps:"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "1. Delete this script:  rm setup-secrets-now.sh"
echo "2. Build the app:       npm run build"
echo "3. Deploy:              npm run deploy"
echo "4. Test:                https://symbolai.net"
echo ""
echo "For more information:"
echo "  - SECRETS_SETUP.md"
echo "  - CONFIGURATION.md"
echo ""
