---
/**
 * Cloudflare Pages Build Status Page
 * Shows recent deployments and build information
 */

const ACCOUNT_ID = import.meta.env.CLOUDFLARE_ACCOUNT_ID;
const API_BASE = 'https://api.cloudflare.com/client/v4';

// Get API token from environment
const API_TOKEN = import.meta.env.CLOUDFLARE_API_TOKEN;

let projects = [];
let error = null;

if (API_TOKEN) {
  try {
    // Fetch Pages projects
    const response = await fetch(`${API_BASE}/accounts/${ACCOUNT_ID}/pages/projects`, {
      headers: {
        'Authorization': `Bearer ${API_TOKEN}`,
        'Content-Type': 'application/json',
      },
    });

    const data = await response.json();

    if (data.success) {
      projects = data.result || [];
    } else {
      error = 'Failed to fetch projects: ' + JSON.stringify(data.errors);
    }
  } catch (e) {
    error = 'API Error: ' + e.message;
  }
} else {
  error = 'API Token not configured. Set CLOUDFLARE_API_TOKEN environment variable.';
}
---

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cloudflare Pages - Build Status</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      background: white;
      border-radius: 15px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    .header h1 {
      color: #667eea;
      font-size: 2.5rem;
      margin-bottom: 10px;
    }

    .header p {
      color: #666;
      font-size: 1.1rem;
    }

    .error-box {
      background: #fee;
      border: 2px solid #c33;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      color: #c33;
    }

    .project-card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    }

    .project-header {
      border-bottom: 2px solid #f0f0f0;
      padding-bottom: 15px;
      margin-bottom: 20px;
    }

    .project-name {
      font-size: 1.8rem;
      color: #333;
      margin-bottom: 10px;
    }

    .project-url {
      color: #667eea;
      text-decoration: none;
      font-size: 1.1rem;
    }

    .project-url:hover {
      text-decoration: underline;
    }

    .deployments {
      margin-top: 20px;
    }

    .deployment {
      background: #f8f9fa;
      border-left: 4px solid #667eea;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
    }

    .deployment.success {
      border-left-color: #28a745;
    }

    .deployment.failure {
      border-left-color: #dc3545;
    }

    .deployment.active {
      border-left-color: #ffc107;
    }

    .deployment-status {
      font-size: 1.2rem;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .deployment-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      font-size: 0.95rem;
      color: #666;
    }

    .info-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .icon {
      font-size: 1.2rem;
    }

    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .badge.success {
      background: #d4edda;
      color: #155724;
    }

    .badge.failure {
      background: #f8d7da;
      color: #721c24;
    }

    .badge.active {
      background: #fff3cd;
      color: #856404;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 2px solid #f0f0f0;
    }

    .stat-card {
      text-align: center;
      padding: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 10px;
      color: white;
    }

    .stat-number {
      font-size: 2rem;
      font-weight: bold;
    }

    .stat-label {
      font-size: 0.9rem;
      opacity: 0.9;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: white;
      font-size: 1.5rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸš€ Cloudflare Pages - Build Status</h1>
      <p>Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ù†Ø§Ø¡ ÙˆØ§Ù„Ù†Ø´Ø± Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Cloudflare Pages</p>
    </div>

    {error && (
      <div class="error-box">
        <strong>âš ï¸ Ø®Ø·Ø£:</strong> {error}
      </div>
    )}

    {!error && projects.length === 0 && (
      <div class="project-card">
        <p style="text-align: center; color: #666;">
          Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Pages ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨.
        </p>
      </div>
    )}

    {projects.map(project => (
      <div class="project-card">
        <div class="project-header">
          <h2 class="project-name">ğŸ“¦ {project.name}</h2>
          <a href={`https://${project.subdomain}`} class="project-url" target="_blank">
            ğŸŒ {project.subdomain}
          </a>
        </div>

        <div class="stats">
          <div class="stat-card">
            <div class="stat-number">{project.production_branch || 'main'}</div>
            <div class="stat-label">Production Branch</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">{new Date(project.created_on).toLocaleDateString('ar-SA')}</div>
            <div class="stat-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡</div>
          </div>
        </div>

        <div id={`deployments-${project.name}`} class="deployments">
          <p style="text-align: center; color: #999; padding: 20px;">
            Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Deployments...
          </p>
        </div>
      </div>
    ))}
  </div>

  <script define:vars={{ projects, ACCOUNT_ID, API_TOKEN, API_BASE }}>
    // Fetch deployments for each project
    async function loadDeployments() {
      for (const project of projects) {
        try {
          const response = await fetch(
            `${API_BASE}/accounts/${ACCOUNT_ID}/pages/projects/${project.name}/deployments?per_page=5`,
            {
              headers: {
                'Authorization': `Bearer ${API_TOKEN}`,
                'Content-Type': 'application/json',
              },
            }
          );

          const data = await response.json();
          const container = document.getElementById(`deployments-${project.name}`);

          if (data.success && data.result && data.result.length > 0) {
            container.innerHTML = '<h3 style="margin-bottom: 15px;">Ø¢Ø®Ø± 5 Deployments:</h3>';

            data.result.forEach(deployment => {
              const stage = deployment.latest_stage || {};
              const metadata = deployment.deployment_trigger?.metadata || {};
              const status = stage.status || 'unknown';

              const statusEmoji = {
                'success': 'âœ…',
                'failure': 'âŒ',
                'active': 'ğŸ”„',
                'queued': 'â³'
              }[status] || 'â“';

              const deploymentDiv = document.createElement('div');
              deploymentDiv.className = `deployment ${status}`;
              deploymentDiv.innerHTML = `
                <div class="deployment-status">
                  ${statusEmoji} <span class="badge ${status}">${status.toUpperCase()}</span>
                </div>
                <div class="deployment-info">
                  <div class="info-item">
                    <span class="icon">ğŸŒ¿</span>
                    <span>${metadata.branch || 'N/A'}</span>
                  </div>
                  <div class="info-item">
                    <span class="icon">ğŸ“</span>
                    <span>${metadata.commit_hash?.substring(0, 7) || 'N/A'}</span>
                  </div>
                  <div class="info-item">
                    <span class="icon">ğŸ“…</span>
                    <span>${new Date(deployment.created_on).toLocaleString('ar-SA')}</span>
                  </div>
                  <div class="info-item">
                    <span class="icon">ğŸ”—</span>
                    <a href="${deployment.url}" target="_blank" style="color: #667eea;">Ø¹Ø±Ø¶</a>
                  </div>
                </div>
                ${metadata.commit_message ? `<p style="margin-top: 10px; color: #666; font-size: 0.9rem;">ğŸ’¬ ${metadata.commit_message}</p>` : ''}
              `;

              container.appendChild(deploymentDiv);
            });
          } else {
            container.innerHTML = '<p style="text-align: center; color: #999;">Ù„Ø§ ØªÙˆØ¬Ø¯ deployments Ù…ØªØ§Ø­Ø©.</p>';
          }
        } catch (error) {
          console.error(`Error loading deployments for ${project.name}:`, error);
          const container = document.getElementById(`deployments-${project.name}`);
          container.innerHTML = `<p style="color: #c33;">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Deployments: ${error.message}</p>`;
        }
      }
    }

    // Load deployments when page is ready
    if (typeof API_TOKEN !== 'undefined' && API_TOKEN) {
      loadDeployments();
    }
  </script>
</body>
</html>
